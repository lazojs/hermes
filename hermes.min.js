// HERMES, sweet llamas of the bahamas
// ----------------------------------
// v0.1.1
//
// Copyright (c)2013 Jason Strimpel
// Distributed under MIT license
function augment(a,b,c){for(var d in b)c&&c[d]||(a[d]=b[d]);return a}function isRegExp(a){return"[object RegExp]"===Object.prototype.toString.call(a)}function isFunction(a){return"function"==typeof a}var hermes,optionalParam=/\((.*?)\)/g,namedParam=/(\(\?)?:\w+/g,splatParam=/\*\w+/g,escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g,rootStripper=/^\/+|\/+$/g,trailingSlash=/\/$/;hermes={start:function(a){var b=this;return this._started||!window.history.pushState?this:(a=a||{},this._handlers=this._handlers||[],this._cache=this._cache||{},augment(this,a,{state:!0,title:!0}),this.root=this.root?("/"+this.root+"/").replace(rootStripper,"/"):void 0,a.state=a.state||{},a.title=a.title||document.title,window.history.replaceState(a.state||{},a.title,this._getUrl()),document.title=a.title,this._setCacheItem(a.title,a.state),this._currentUrl={pathname:window.location.pathname,search:window.location.search},b._backboneEvents(),b._bindRoutes(),setTimeout(function(){b._bindPopState()},0),this._started=!0,this)},getPreviousUrl:function(){return this._lastUrl?this._lastUrl.pathname+this._lastUrl.search:""},stop:function(){window.removeEventListener("popstate",this._popstateListener),this._started=!1},route:function(a,b,c){var d,e=this,f=a.match(/:\w*/g)||[];return a=isRegExp(a)?a:this._routeToRegExp(a),isFunction(b)&&(c=b,b=""),this._handlers=this._handlers||[],this._handlers.unshift({route:a,callback:function(g){d=e._getParams(a,f),isFunction(c)&&c.apply(e,[window.location.pathname,d,g]),e._backboneEventsAugmented&&(e.trigger.apply(e,["route:"+b].concat(d,g)),e.trigger("route",b,d,g))}}),this},destroyRoutes:function(){this._handlers=[]},navigate:function(a,b){window.history.pushState||(window.location=a),b=b||{},b.state=b.state||{},b.title=b.title||document.title,window.history[b.replace?"replaceState":"pushState"](b.state,b.title,a),document.title=b.title,this._setCacheItem(b.title,b.state),(void 0===b.trigger||b.trigger)&&this._loadUrl(b.state)},getItem:function(a){return this._cache[a||this._getUrl()]},clearCache:function(){return this._cache={},this},updateState:function(a,b){var c=this.getItem(b);this._setCacheItem(c.title,a,b),window.history.replaceState(a,c.title,b||this._getUrl())},_setCacheItem:function(a,b,c){var d=this._cache[c||this._getUrl()]={title:a};return this.cache&&(d.state=b),this},_getUrl:function(){return window.location.pathname+window.location.search},_getParams:function(a,b){var c,d,e=/\+/g,f=/([^&=]+)=?([^&]*)/g,g=function(a){return decodeURIComponent(a.replace(e," "))},h=window.location.search.substring(1),i={};d=a.exec(this._stripRoot(window.location.pathname)).slice(1);for(var j=0;j<b.length;j++)i[b[j].substring(1)]=d[j]||null;for(;c=f.exec(h);)i[g(c[1])]=g(c[2]);return i},_routeToRegExp:function(a){return a=a.replace(escapeRegExp,"\\$&").replace(optionalParam,"(?:$1)?").replace(namedParam,function(a,b){return b?a:"([^/]+)"}).replace(splatParam,"(.*?)"),new RegExp("^"+a+"$")},_stripRoot:function(a){var b;return a="/"===a.substring(0,1)?a.substring(1):a,this.root?(b=this.root.replace(trailingSlash,""),a=0===a.indexOf(b)?a.substr(b.length):void 0):a},_backboneEvents:function(){return!this.Backbone||this._backboneEventsAugmented?this:(augment(this,Backbone.Events),this._backboneEventsAugmented=!0,this)},_bindPopState:function(){var a=this;return this._popstateListener=window.addEventListener("popstate",function(b){var c=a.getItem();a._loadUrl(b.state),document.title=c?c.title:document.title}),this},_bindRoutes:function(){var a;if(!this.routes||this._routesBound)return this;a=isFunction(this.routes)?this.routes():this.routes;for(var b in this.routes)this.route(b,this.routes[b]);return this._routesBound=!0,this},_loadUrl:function(a){var b=this._handlers,c=this._stripRoot(window.location.pathname),d=b.length;a=a||{};for(var e=0;d>e;e++)if(b[e].route.test(c)){b[e].callback(a),this._lastUrl={pathname:this._currentUrl.pathname,search:this._currentUrl.search},this._currentUrl={pathname:window.location.pathname,search:window.location.search};break}return this}};